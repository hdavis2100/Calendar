<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calculator</title>
    <link rel="stylesheet" href="styles.css"/>

</head>
<body>
    <div id="loginForm">
    <label for="usernameinput">Username:</label>
    <input type="text" name="username" id="usernameinput" />
    <label for="passwordinput"> Password</label>
    <input type="password" name="password" id="passwordinput" />
    <button id="loginbutton">Login</button>
    </div>

    <div id="createAccountForm">
    <label for="createAccount">Create Account:</label>
    <input type="text" name="createAccountUsername" id="createAccountUsername" />
    <label for="createAccountPassword"> Password</label>
    <input type="password" name="createAccountPassword" id="createAccountPassword" />
    <button id="createAccountButton">Create Account</button>
    </div>
    
    <div id="logoutForm">
    <label for="logoutButton">Logout:</label>
    <button id="logoutButton">Logout</button>
    </div>
    

    <label id="calendarLabel" for="calendar"></label>
    <table id="calendar">
        <thead>
            <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
            </tr>
        </thead>
        <tbody id="calBody">
            
        </tbody>
        <button id="prev_month_btn">Previous Month</button>
        <button id="next_month_btn">Next Month</button>

    </table>

    <div id="addEventForm">
        <p> Add an Event: Your date must be in the format Year-Month-Date (ex: 2023-3-15, 20000-12-1), and your time must be in the format hour:minute (ex: 14:30, 6:05)</p>
    
        <label for="eventTitle">Event Title:</label>
        <input type="text" id="eventTitle" />
        <label for ="eventDate">Event Date:</label>
        <input type="text" id="eventDate" />
        <label for="eventTime">Event Time:</label>
        <input type="text" id="eventTime" />
        <button id="addEventButton">Add Event</button>

    </div>
</body>
</html>
<script src="calendarMin.js"></script>

<script>
        // For our purposes, we can keep the current month in a variable in the global scope
    let currentMonth = new Month(new Date().getFullYear(), new Date().getMonth()); // Current month
    addEvent = function() {
        const title = document.getElementById("eventTitle").value;
        const date = document.getElementById("eventDate").value;
        const time = document.getElementById("eventTime").value;
        const data = { 'title': title, 'date': date, 'time': time };
        fetch("addEvent.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then( () => 
        updateCalendar(),
        document.getElementById("eventTitle").value = "",
        document.getElementById("eventDate").value = "",
        document.getElementById("eventTime").value = ""
    )

        .catch(error => console.error('Error:',error))
        

    };

    getEventsByDate = function(year, month, day) {
        
        fetch("getEventsByDate.php", {
            method: 'POST',
            body: JSON.stringify({ 'year': year, 'month': month, 'day': day }),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => {
            return data.events;
        })
        .catch(error => console.error('Error:',error))
        
    };

    // Change the month when the "next" button is pressed
    document.getElementById("next_month_btn").addEventListener("click", function(event){
        currentMonth = currentMonth.nextMonth(); // Previous month would be currentMonth.prevMonth()
        updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
        
    }, false);
    
    document.getElementById("prev_month_btn").addEventListener("click", function(event){
        currentMonth = currentMonth.prevMonth(); 
        updateCalendar(); 
        
    }, false);


    // This updateCalendar() function only alerts the dates in the currently specified month.  You need to write
    // it to modify the DOM (optionally using jQuery) to display the days and weeks in the current month.
    function updateCalendar(){
        document.getElementById("calendarLabel").innerText = currentMonth.month + " " + currentMonth.year;
        let weeks = currentMonth.getWeeks();
        let calBody = document.getElementById("calBody");
        calBody.innerHTML = ""; 

        for(let w in weeks){
            let days = weeks[w].getDates();
            
            const row = document.createElement("tr");

            
            
            for(let d in days){
                const cell = document.createElement("td");
                cell.innerText = days[d].getDate();
                events = getEventsByDate(days[d].getFullYear(), days[d].getMonth(), days[d].getDate());
                
                for(let e in events){
                    const eventDiv = document.createElement("div");
                    title = events[e].title;
                    time = events[e].time;
                    eventDiv.innerText = time + " " + title;
                    cell.appendChild(eventDiv);
                }
                row.appendChild(cell);
                
            }
            calBody.appendChild(row);
        }
    }
    let setContent = function() {
        
        fetch("setContent.php", {
            method: 'GET',
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                document.getElementById("loginForm").hidden = true;
                document.getElementById("createAccountForm").hidden = true;
                document.getElementById("addEventForm").hidden = true;
                document.getElementById("logoutForm").hidden = false;
                document.getElementById("eventTitle").value = "";
                document.getElementById("eventDate").value = "";
                document.getElementById("eventTime").value = "";
                

            }
            else {
                document.getElementById("loginForm").hidden = false;
                document.getElementById("usernameinput").value = "";
                document.getElementById("passwordinput").value = "";
                document.getElementById("createAccountUsername").value = "";
                document.getElementById("createAccountPassword").value = "";
                document.getElementById("createAccountForm").hidden = false;
                document.getElementById("addEventForm").hidden = true;


                document.getElementById("logoutForm").hidden = true;
            }
            updateCalendar();
        })
        .catch(error => console.error('Error:',error))
    };
    document.addEventListener("DOMContentLoaded", setContent, false);

    let login = function() {
        const username = document.getElementById("usernameinput").value;
        const password = document.getElementById("passwordinput").value;
        const data = { 'username': username, 'password': password };
        fetch("login.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        

    };
    
    let createAccount = function() {
        const username = document.getElementById("createAccountUsername").value;
        const password = document.getElementById("createAccountPassword").value;
        const data = { 'username': username, 'password': password };
        fetch("storeNewUser.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "Account created successfully!" : `Account creation failed: ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        

    };

    let logout = function() {
        fetch("logout.php", {
            method: 'POST',
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "You've been logged out!" : `You were not logged out ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        

    };
    document.getElementById("loginbutton").addEventListener("click", login, false);
    document.getElementById("createAccountButton").addEventListener("click", createAccount, false);
    document.getElementById("logoutButton").addEventListener("click", logout, false);
    document.getElementById("addEventButton").addEventListener("click", addEvent, false);
    

</script>