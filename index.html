<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calendar</title>
    <link rel="stylesheet" href="styles.css"/>

</head>
<body>
    <div id="loginForm">
    <label for="usernameinput">Username:</label>
    <input type="text" name="username" id="usernameinput" />
    <label for="passwordinput"> Password</label>
    <input type="password" name="password" id="passwordinput" />
    <button id="loginbutton">Login</button>
    </div>

    <div id="createAccountForm">
    <label for="createAccount">Create Account:</label>
    <input type="text" name="createAccountUsername" id="createAccountUsername" />
    <label for="createAccountPassword"> Password</label>
    <input type="password" name="createAccountPassword" id="createAccountPassword" />
    <button id="createAccountButton">Create Account</button>
    </div>
    
    <div id="logoutForm">
    <label for="logoutButton">Logout:</label>
    <button id="logoutButton">Logout</button>
    </div>
    
    <!-- Store Calendar as Grid -->
    <label id="calendarLabel" for="calendar"></label>
    <table id="calendar">
        <thead>
            <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
            </tr>
        </thead>
        <tbody id="calBody">
            <!-- Populate in js -->
            
        </tbody>
        <button id="prev_month_btn">Previous Month</button>
        <button id="next_month_btn">Next Month</button>

    </table>

    <div id="addEventForm">
        <p> Add an Event: Your date must be in the format Year-Month-Date (ex: 2023-3-15, 20000-12-1), and your time must be in the format hour:minute (ex: 14:30, 6:05)</p>
    
        <label for="eventTitle">Event Title:</label>
        <input type="text" id="eventTitle" />
        <label for ="eventDate">Event Date:</label>
        <input type="text" id="eventDate" />
        <label for="eventTime">Event Time:</label>
        <input type="text" id="eventTime" />
        
        <button id="addEventButton">Add Event</button>

    </div>

    <div id="groupForm">
        <p> Add Group Member to event: Type the username of the member and select a permission level. Limited will allows members to only see the event while full will allow full permissions. None will remove members from the group. Only limited permissions members can be removed.</p>
        <label for="memberName">Member Name:</label>
        <input type="text" id="memberName" />
        <label for="permission">Permission Level:</label>
        <input type="radio" id="perLimited" name="permission" value="limited" />
        <label for="perLimited">Limited</label>
        <input type="radio" id="perFull" name="permission" value="full" />
        <label for="perFull">Full</label>
        <input type="radio" id="perNone" name="permission" value="none" />
        <label for="perNone">None</label>
    </div>

    <!-- Form to edit event details. Each event given edit button which pulls data from this form and updates by eventId on click-->
    <div id="editEventForm">
        <p> Edit an Event: Enter Updated details below and click the edit button for your desired event to edit. If you want to leave a field unchanged, just leave it blank.</p>
        <label for="editEventTitle">New Event Title:</label>
        <input type="text" id="editEventTitle" />
        <label for="editEventDate">New Event Date:</label>
        <input type="text" id="editEventDate" />
        <label for="editEventTime">New Event Time:</label>
        <input type="text" id="editEventTime" />
        </div>
    <div id="tagEventForm">
        <p> Add an Event Tag: Enter the tag below and click the tag button on the event in your calendar.</p>
        <label for="tagEvent">Tag Event:</label>
        <input type="text" id="tagEvent" />
    </div>
    <div id="filterByTag">
        <p> Enter a tag to only view events with that tag:</p>
        <label for="filterTag">Filter by Tag:</label>
        <input type="text" id="filterTag" />
        <button id="filterButton">Filter</button>
    </div>
        <div id="shareCal">
            <h3> Click a user to share or unshare your calendar with them:</h3>
            <ul id="userList">
                
            </ul>
            
        </div>

        <div id="switchCalendar">

            <h3> Click a user to view their calendar:</h3>
            <p> Currently viewing: <span id="currentViewUser"></span></p>
            <ul id="calendarList">
                
            </ul>
        </div>
        
</body>
</html>
<script src="calendarMin.js"></script>

<script>
        // For our purposes, we can keep the current month in a variable in the global scope
    let currentMonth = new Month(new Date().getFullYear(), new Date().getMonth()); // Current month
    let token = "";
    let username = "";
    let currView = "";
    let currViewUser = document.getElementById("currentViewUser");
    let filter = "";

    // Get event data from input and send to addEvent.php to store in database
    let addEvent = function() {
        const title = document.getElementById("eventTitle").value;
        const date = document.getElementById("eventDate").value;
        const time = document.getElementById("eventTime").value;
        const data = { 'title': title, 'date': date, 'time': time, 'token': token };
        fetch("addEvent.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then( () => {
        
        // Display updated calendar and clear input fields
        updateCalendar();
        document.getElementById("eventTitle").value = "";
        document.getElementById("eventDate").value = "";
        document.getElementById("eventTime").value = "";
    })

        .catch(error => console.error('Error:',error))
        

    };

    

    // Change the month when the "next" button is pressed
    document.getElementById("next_month_btn").addEventListener("click", function(event){
        currentMonth = currentMonth.nextMonth(); // Previous month would be currentMonth.prevMonth()
        updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
        
    }, false);
    
    // Change the month when the "previous" button is pressed
    document.getElementById("prev_month_btn").addEventListener("click", function(event){
        currentMonth = currentMonth.prevMonth(); 
        updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
        
    }, false);


    // Populates the calendar. Gets all dates using calendarMin.js, fetches events for those dates, and maps each valid date to corresponding events to be displayed
    function updateCalendar(){

        if(!username){
            return;
        }
        
        document.getElementById("calendarLabel").innerText = (currentMonth.month + 1) + " " + currentMonth.year;
        let weeks = currentMonth.getWeeks();
        let calBody = document.getElementById("calBody");
        calBody.innerHTML = ""; 
        
        // All event actions call update, refresh all inputs here
        document.getElementById("eventTitle").value = "";
        document.getElementById("eventDate").value = "";
        document.getElementById("eventTime").value = "";
        document.getElementById("editEventTitle").value = "";
        document.getElementById("editEventDate").value = "";
        document.getElementById("editEventTime").value = "";
        document.getElementById("tagEvent").value = "";
        // dates will hold all dates in the current month to be sent to getEvents.php and eventsByDate will map dates to their corresponding events
        dates = [];
        eventsByDate = {};
        for(let w in weeks){
            let days = weeks[w].getDates();
            
            for(let d in days){
                
                // Dates are stored in the "val" format in database
                val = days[d].getFullYear() + "-" + (days[d].getMonth()) + "-" + days[d].getDate();
                eventsByDate[val] = [];

                if (days[d].getMonth() != currentMonth.month) {
                    continue;
                }

                dates.push([days[d].getFullYear(), days[d].getMonth() + 1, days[d].getDate(), currView]);
                
            }
        }

        fetch("getEvents.php", {
            method: 'POST',
            body: JSON.stringify(dates),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => {
            let userDict = data.users;
            let userList = document.getElementById("userList");
            let calendarList = document.getElementById("calendarList");
            
            calendarList.innerHTML = "";
            // Populate calendar list for switching views
            for (let user of data.views){
                let calItem = document.createElement("li");
                calItem.innerText = user == username ? user + " (Your Calendar)" : user;
                viewButton = document.createElement("button");
                viewButton.innerText = "View";
                calendarList.appendChild(calItem);
                calItem.appendChild(viewButton);
                // Switch calendar view on click
                viewButton.addEventListener("click", function() {
                    currView = user === username ? "" : user;
                    document.getElementById("currentViewUser").innerText = currView == "" ? "Your Calendar" : currView;
                    updateCalendar();
                }, false);
            }

            // Populate user list for sharing calendars
            userList.innerHTML = "";
            for (let user of Object.keys(userDict)){
                let userItem = document.createElement("li");
                let shareStatus = userDict[user];
                userItem.innerText = user;
                let shareButton = document.createElement("button");
                shareButton.innerText = shareStatus ? "Unshare" : "Share";
                userItem.appendChild(shareButton);
                // Share or unshare calendar on click
                shareButton.addEventListener("click", function() {
                    let data = { 'dest': user, 'shareStatus': shareStatus, 'token': token };
                    fetch("addShare.php", {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: { 'content-type': 'application/json' }
                    
                    })
                    .then(response => response.json())
                    .then( () => updateCalendar())
                    .catch(error => console.error('Error:',error))
                }, false);
                userList.appendChild(userItem);

            }

            if (currView === ""){

                        document.getElementById("editEventForm").hidden = false;
                        document.getElementById("addEventForm").hidden = false;
                        document.getElementById("tagEventForm").hidden = false;
                        document.getElementById("groupForm").hidden = false;
            }
            else{
                        document.getElementById("editEventForm").hidden = true;
                        document.getElementById("addEventForm").hidden = true;
                        document.getElementById("tagEventForm").hidden = true;
                        document.getElementById("groupForm").hidden = true;
            }
                
            // Map each date to its corresponding events
            for(let e in data.events) {
                let event = data.events[e];

                // Date not formatted via php due to off by 1 month adjustment. Reformat here for key access
                let date = event.year + "-" + event.month + "-" + event.day;
                let title = event.title;
                let time = event.time;
                let id = event.id;
                let tag = event.tag;
                let permission = event.permission;
                let creator = event.creator;
                

                // Only display events with tag match, if filter not set display all
                if (filter && tag != filter){
                    continue;
                }
                eventsByDate[date].push({ 'title': title, 'time': time, 'id': id, 'tag': tag, 'permission': permission, 'creator': creator } );

            }
            for(let w in weeks){
            let days = weeks[w].getDates();

            const row = document.createElement("tr");
            for(let d in days){

                const cell = document.createElement("td");
                cell.innerText = days[d].getDate();
                let cellDateKey = days[d].getFullYear() + "-" + (days[d].getMonth()) + "-" + days[d].getDate();
                if (eventsByDate[cellDateKey] === undefined) {
                    continue;
                }

                // Sort events by time before displaying
                eventsByDate[cellDateKey].sort( (a,b) => {
                    return a.time.localeCompare(b.time);
                });

                // Create a div for each event along with delete and edit buttons
                for(let e in eventsByDate[cellDateKey]) {
                    let event = eventsByDate[cellDateKey][e];
                    let eventDiv = document.createElement("div");
                    let tag = event.tag;
                    eventDiv.innerHTML = event.time + " : " + event.title + " Created by " + event.creator + " - tag: " + tag;
                    

                    if (currView === ""){
                        // Delete button always attached so users can delete references
                        let delButton = document.createElement("button");
                        delButton.innerText = "Delete";
                            
                        // Delete and update by stored event id
                        delButton.addEventListener("click", function() {
                            let data = { 'id': event.id, 'token': token, date: cellDateKey, title: event.title, time: event.time, tag: event.tag };
                            fetch("deleteEvent.php", {
                                method: 'POST',
                                body: JSON.stringify(data),
                                headers: { 'content-type': 'application/json' }
                                
                            })
                            .then(response => response.json())
                            .then( () => updateCalendar())
                            .catch(error => console.error('Error:',error))
                        }, false);
                            
                        eventDiv.appendChild(delButton);
                    }

                    if (event.permission == "limited"){
                        // Limited permission events cannot be edited or deleted
                        cell.appendChild(eventDiv);
                        continue;
                    }
                    
                    // Only allow deletion and editing if viewing own calendar
                    // Enforced username > 2 characters so no issues with condition on currView
                    if (currView === ""){

                        let groupButton = document.createElement("button");
                        groupButton.innerText = "Update Group";
                        groupButton.addEventListener("click", function() {

                            // Get new group member and permission level from inputs
                            let memberName = document.getElementById("memberName").value;
                            let permissionLevel = "";
                            if (document.getElementById("perLimited").checked){
                                permissionLevel = "limited";
                            }
                            else if (document.getElementById("perFull").checked){
                                permissionLevel = "full";
                            }
                            else if (document.getElementById("perNone").checked){
                                permissionLevel = "none";
                            }
                            else {
                             
                                return;
                            }

                            let data = { 'id': event.id, 'memberName': memberName,  'permissionLevel': permissionLevel, 'token': token };
                            fetch("updateGroup.php", {
                                method: 'POST',
                                body: JSON.stringify(data),
                                headers: { 'content-type': 'application/json' }
                            
                            })
                            .then(response => response.json())
                            .then(() => {
                                updateCalendar();
                            })
                            .catch(error => console.error('Error:', error));

                        });
                        eventDiv.appendChild(groupButton);


                        let tagButton = document.createElement("button");
                        tagButton.innerText = tag ? "UnTag" : "Tag";

                        if (tag){
                            tagButton.addEventListener("click", function() {
                                let data = { 'id': event.id, 'tag': null, 'token':  token, 'creator': event.creator };
                                fetch("tagEvent.php", {
                                    method: 'POST',
                                    body: JSON.stringify(data),
                                    headers: { 'content-type': 'application/json' }
                                
                                })
                                .then(response => response.json())
                                .then( () => updateCalendar())
                                .catch(error => console.error('Error:',error))
                            }, false);
                        }
                        else {
                            tagButton.addEventListener("click", function() {


                                let data = { 'id': event.id, 'tag': document.getElementById("tagEvent").value, 'token': token, 'creator': event.creator };
                                fetch("tagEvent.php", {
                                    method: 'POST',
                                    body: JSON.stringify(data),
                                    headers: { 'content-type': 'application/json' }
                                
                                })
                                .then(response => response.json())
                                .then( () => updateCalendar())
                                .catch(error => console.error('Error:',error))
                            }, false);
                        }
                        eventDiv.appendChild(tagButton);

                        
                        
                       
                        
                    
                    
                        let editButton = document.createElement("button");
                        editButton.innerText = "Edit";
                        editButton.addEventListener("click", function() {

                            // Get new event fields from edit event inputs
                            const newTitle = document.getElementById("editEventTitle").value;
                            const newDate = document.getElementById("editEventDate").value;
                            const newTime = document.getElementById("editEventTime").value;

                            // Blank fields handled in editEvent.php
                            let data = { 'id': event.id, 'newTitle': newTitle,  'newDate': newDate, 'newTime': newTime, 'token': token, 'creator': event.creator };
                            fetch("editEvent.php", {
                                method: 'POST',
                                body: JSON.stringify(data),
                                headers: { 'content-type': 'application/json' }
                            
                            })
                            .then(response => response.json())
                            .then(() => {
                                updateCalendar();
                            })
                            .catch(error => console.error('Error:', error));

                        });
                        eventDiv.appendChild(editButton);
                        
                    }
                    
                    
                    cell.appendChild(eventDiv);
                }
                
                
                
                row.appendChild(cell);
                
            }
            calBody.appendChild(row);
        }
        })
        .catch(error => console.error('Error:',error));

    }

        
        
     let changeFilter = function() {
        filter = document.getElementById("filterTag").value;
        updateCalendar();
     };   
     document.getElementById("filterButton").addEventListener("click", changeFilter);
    
    let setContent = function() {

        // Reset current month on login/logout/refresh
        currentMonth = new Month(new Date().getFullYear(), new Date().getMonth());
        currView = "";
        filter = "";
        
        fetch("setContent.php", {
            method: 'POST',
            
        
        })
        .then(response => response.json())
        .then(data => {

            // Show content based on login status
            if(data.success) {
                document.getElementById("loginForm").hidden = true;
                document.getElementById("createAccountForm").hidden = true;
                document.getElementById("addEventForm").hidden = false;
                document.getElementById("logoutForm").hidden = false;
                document.getElementById("eventTitle").value = "";
                document.getElementById("eventDate").value = "";
                document.getElementById("eventTime").value = "";
                document.getElementById("editEventForm").hidden = false;
                document.getElementById("editEventTitle").value = "";
                document.getElementById("editEventDate").value = "";
                document.getElementById("editEventTime").value = "";
                document.getElementById("shareCal").hidden = false;
                document.getElementById("switchCalendar").hidden = false;
                document.getElementById("calendarLabel").hidden = false;
                document.getElementById("calendar").hidden = false;
                document.getElementById("tagEvent").hidden = false;
                document.getElementById("filterByTag").hidden = false;
                document.getElementById("groupForm").hidden = false;
                document.getElementById("tagEventForm").hidden = false;
                document.getElementById("prev_month_btn").hidden = false;
                document.getElementById("next_month_btn").hidden = false;
                token = data.token;
                username = data.username;

                currViewUser.innerText = "Your Calendar";

            }
            else {
                document.getElementById("loginForm").hidden = false;
                document.getElementById("usernameinput").value = "";
                document.getElementById("passwordinput").value = "";
                document.getElementById("createAccountUsername").value = "";
                document.getElementById("createAccountPassword").value = "";
                document.getElementById("createAccountForm").hidden = false;
                document.getElementById("addEventForm").hidden = true;
                document.getElementById("editEventForm").hidden = true;
                document.getElementById("shareCal").hidden = true;
                document.getElementById("switchCalendar").hidden = true;
                document.getElementById("calendarLabel").hidden = true;
                document.getElementById("calendar").hidden = true;
                document.getElementById("tagEventForm").hidden = true;
                document.getElementById("tagEvent").hidden = true;
                document.getElementById("filterByTag").hidden = true;
                document.getElementById("groupForm").hidden = true;
                document.getElementById("prev_month_btn").hidden = true;
                document.getElementById("next_month_btn").hidden = true;
                currViewUser.innerText = "";
                token = "";
                username = "";


                document.getElementById("logoutForm").hidden = true;
            }

            // Populate Calendar
            updateCalendar();
        })
        .catch(error => console.error('Error:',error))

    };

    // Populate content on page load
    document.addEventListener("DOMContentLoaded", setContent, false);

    let login = function() {
        const username = document.getElementById("usernameinput").value;
        const password = document.getElementById("passwordinput").value;
        const data = { 'username': username, 'password': password };
        fetch("login.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        

    };
    
    let createAccount = function() {
        const username = document.getElementById("createAccountUsername").value;
        const password = document.getElementById("createAccountPassword").value;
        const data = { 'username': username, 'password': password };
        fetch("storeNewUser.php", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "Account created successfully!" : `Account creation failed: ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        

    };

    let logout = function() {
        fetch("logout.php", {
            method: 'POST',
            headers: { 'content-type': 'application/json' }
        
        })
        .then(response => response.json())
        .then(data => console.log(data.success ? "You've been logged out!" : `You were not logged out ${data.message}`))
        .then( () => setContent())
        .catch(error => console.error('Error:',error))
        
        

    };

    
    document.getElementById("loginbutton").addEventListener("click", login, false);
    document.getElementById("createAccountButton").addEventListener("click", createAccount, false);
    document.getElementById("logoutButton").addEventListener("click", logout, false);
    document.getElementById("addEventButton").addEventListener("click", addEvent, false);
    

</script>